/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Groovy project to get you started.
 * For more details take a look at the Groovy Quickstart chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.0.1/userguide/tutorial_groovy_projects.html
 */

plugins {
    id 'com.github.johnrengelman.shadow' version '5.2.0'
    id 'java'
    id 'groovy'
    id 'maven-publish'
}

configurations {
    jossoAgent { transitive = false }
}

dependencies {
    // Use the latest Groovy version for building this library
    implementation 'org.codehaus.groovy:groovy-all:2.3.7'

    // Use the awesome Spock testing and specification framework
    testImplementation 'org.spockframework:spock-core:1.1-groovy-2.3'

    implementation 'org.yaml:snakeyaml:1.25'
    implementation 'com.github.pcj:google-options:1.0.0'

    def tomcatVersion = System.properties['tomcat.version']?:'7.0.99'
    println "tomat version: '${tomcatVersion}'"
    implementation "org.apache.tomcat.embed:tomcat-embed-core:${tomcatVersion}",
           "org.apache.tomcat.embed:tomcat-embed-jasper:${tomcatVersion}",
           "org.apache.tomcat.embed:tomcat-embed-el:${tomcatVersion}",
           "org.apache.tomcat:tomcat-jasper:${tomcatVersion}",
           "org.apache.tomcat:tomcat-jasper-el:${tomcatVersion}",
           "org.apache.tomcat:tomcat-jsp-api:${tomcatVersion}",
           "org.apache.tomcat.embed:tomcat-embed-logging-juli:${tomcatVersion}",
           "org.apache.tomcat.embed:tomcat-embed-logging-log4j:${tomcatVersion}",
           "org.apache.tomcat:tomcat-annotations-api:${tomcatVersion}",
           "org.apache.tomcat.embed:tomcat-embed-websocket:${tomcatVersion}",
           "org.apache.tomcat:tomcat-jdbc:${tomcatVersion}"

    // jossoAgent 'com.opuscapita.josso:tomcat7-agent-oce:2.1.4:bin@zip'
    def jossoVersion = System.properties['josso.version']?:"2.1.5-custom-component-keeper-factory-SNAPSHOT"
    println "josso version: '${jossoVersion}'"
    jossoAgent "com.opuscapita.josso:tomcat7-agent-oce:${jossoVersion}:bin@zip"
}

task unzipJosso(type: Copy) {
    from zipTree(configurations.jossoAgent.singleFile).matching {
        // we ned only jar files
        // josso agent also contains 'josso-agent-config.xml'
        // but this file we would create/configure from scratch at
        // application startup
        include '*/lib/*.jar'
    }
    eachFile {fcp ->
        fcp.path = "./"
        fcp.name = fcp.sourceName
    }
    into "$buildDir/josso-agent"
    includeEmptyDirs = false
}
compileJava.dependsOn(unzipJosso)

shadowJar {
    def applicationWarFilePath = System.properties['application.war']
    doFirst {
        // as a first step validate that application war file path is specified
        if (!applicationWarFilePath) {
            throw new GradleException("System property 'application.warFilePath' value is not defined!")
        }
        if (!new File(applicationWarFilePath).exists()) {
            throw new GradleException("Application war file is not found by path '${applicationWarFilePath}'!")
        }
        // add josso agent libraries (jar files) into archive
        from(new File("$buildDir/josso-agent").listFiles())
    }

    // excluding dependencies that are used for tests
    dependencies {
        exclude(dependency(':testng:'))
        exclude(dependency(':junit:'))
        // exclude(dependency('org.codehaus.groovy:'))
        exclude(dependency('org.spockframework:'))
    }

    manifest {
        // defining class that runs and configure application
        attributes 'Main-Class': 'man.sab.Main'
    }

    // result jar file will have name <...>-executable.jar
    classifier = 'executable'

    // copy original war file into result JAR
    // into 'META-INF' filder by name 'application.war'
    from (applicationWarFilePath) {
        into ("META-INF")
        rename {fileName -> 'application.war'}
    }
}

publishing {
    publications {
        shadow(MavenPublication) { publication ->
            // todo: find a way to validate/set this properties only at the point of corresponding publish task execution
            // at the moment the following code is executed at project evaluation (in fact any task execution)
            def applicationGroupId = System.properties['application.groupId']
            def applicationArtifactId = System.properties['application.artifactId']
            def applicationVersion = System.properties['application.version']

            // as a first step validate that application war file path is specified
            if (!applicationGroupId) {
                throw new GradleException("System property 'application.groupId' value is not defined!")
            }
            if (!applicationArtifactId) {
                throw new GradleException("System property 'application.artifactId' value is not defined!")
            }
            if (!applicationVersion) {
                throw new GradleException("System property 'application.version' value is not defined!")
            }
            groupId applicationGroupId
            artifactId applicationArtifactId
            version applicationVersion

            project.shadow.component(publication)
        }
    }
}

// task for checking whick repositories are configured
task listRepositories {
    doLast {
        println "Repositories:"
        project.repositories.each {
           println "Name: ${it.name}; url: ${it.url}"
        }
   }
}
